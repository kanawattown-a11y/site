<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Ù…Ø¹Ø±Ø¶ Ù†Ø¬ÙˆÙ… Ø§Ù„Ø¬Ø²ÙŠØ±Ø© - Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #3b82f6; --secondary: #f97316; --accent: #14b8a6;
      --bg-dark: #111827; --bg-light: #1f2937; --text-light: #f9fafb;
      --text-muted: #9ca3af; --glass: rgba(31, 41, 55, 0.6);
      --glass-border: rgba(255, 255, 255, 0.15); --glass-strong: rgba(17, 24, 39, 0.75);
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%; margin: 0; padding: 0; background: var(--bg-dark);
      font-family: 'Cairo', system-ui, sans-serif; overflow: hidden; color: var(--text-light);
    }
    #app { position: fixed; inset: 0; cursor: grab; }
    #app.looking { cursor: grabbing; }
    canvas { display: block; }

    /* --- Loading Screen --- */
    .loading-screen {
      position: fixed; inset: 0; background: var(--bg-dark); display: flex;
      flex-direction: column; align-items: center; justify-content: center;
      z-index: 1000; transition: opacity 1s ease, visibility 1s; transition-delay: 0.5s;
    }
    .loading-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
    .logo {
      width: 140px; height: 140px; background: var(--glass-strong); border: 3px solid var(--glass-border);
      border-radius: 25px; display: flex; align-items: center; justify-content: center;
      font-size: 28px; font-weight: 700; margin-bottom: 24px; backdrop-filter: blur(15px);
      animation: logoFloat 3s ease-in-out infinite; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    }
    @keyframes logoFloat { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    .loading-text { font-size: 20px; font-weight: 600; margin-bottom: 12px; }
    .loading-bar { width: 250px; height: 6px; background: var(--glass); border-radius: 3px; overflow: hidden; }
    .loading-progress { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--accent)); width: 0%; transition: width 0.3s ease; }

    /* --- UI --- */
    .ui-container { position: fixed; inset: 0; pointer-events: none; z-index: 100; padding: 20px; }
    .interaction-prompt {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, 80px);
      background: var(--glass-strong); border: 1px solid var(--glass-border); border-radius: 8px;
      padding: 8px 16px; font-size: 14px; backdrop-filter: blur(10px);
      opacity: 0; transition: opacity 0.3s; pointer-events: none;
    }
    .interaction-prompt.visible { opacity: 1; }
    .crosshair {
        position: absolute; top: 50%; left: 50%; width: 4px; height: 4px;
        background: white; border-radius: 50%; transform: translate(-50%, -50%);
        box-shadow: 0 0 10px white;
    }

    /* --- Control Panel --- */
    .control-panel {
      position: absolute; bottom: 20px; right: 20px; width: 300px;
      background: var(--glass-strong); border: 1px solid var(--glass-border);
      border-radius: 15px; backdrop-filter: blur(15px);
      padding: 20px; pointer-events: auto; display: flex; flex-direction: column; gap: 15px;
      transform: translateY(calc(100% + 20px)); transition: transform 0.5s ease-in-out;
    }
    .control-panel.visible { transform: translateY(0); }
    .panel-group { display: flex; flex-direction: column; gap: 10px; }
    .panel-title { font-weight: 600; margin: 0; text-align: center; padding-bottom: 10px; border-bottom: 1px solid var(--glass-border); }
    .panel-row { display: flex; justify-content: space-between; align-items: center; }
    .panel-label { font-size: 14px; font-weight: 500; color: var(--text-muted); }
    .panel-slider {
      width: 60%; -webkit-appearance: none; appearance: none; height: 5px;
      background: var(--glass); border-radius: 5px; outline: none; cursor: pointer;
    }
    .panel-slider::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 18px; height: 18px;
      background: var(--secondary); border-radius: 50%; border: 2px solid white;
    }
    .panel-slider::-moz-range-thumb {
      width: 18px; height: 18px; background: var(--secondary);
      border-radius: 50%; border: 2px solid white;
    }
    .color-swatches { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; }
    .swatch {
      width: 25px; height: 25px; border-radius: 50%; cursor: pointer;
      border: 2px solid transparent; transition: all 0.2s ease;
    }
    .swatch:hover { transform: scale(1.1); }
    .swatch.active { border-color: white; }
    .panel-btn {
      background: var(--glass); border: 1px solid var(--glass-border); color: var(--text-light);
      padding: 10px 15px; border-radius: 8px; cursor: pointer; transition: background 0.2s ease;
      font-family: inherit; font-size: 14px; text-align: center;
    }
    .panel-btn:hover { background: var(--glass-border); }
    .panel-btn.active { background: var(--accent); color: white; }
    
    /* Mobile Controls */
    .mobile-controls { display: none; }
    @media (max-width: 768px), (pointer: coarse) {
        .control-panel { width: calc(100% - 40px); left: 20px; }
        .mobile-controls.visible { display: block; }
        .joystick-zone { position: absolute; width: 150px; height: 150px; bottom: 20px; }
        #move-joystick { left: 20px; }
        #look-joystick { right: 20px; }
        .joystick-base { width: 100%; height: 100%; background: rgba(31, 41, 55, 0.5); border-radius: 50%; border: 1px solid var(--glass-border); }
        .joystick-stick { position: absolute; top: 50%; left: 50%; width: 60px; height: 60px; background: var(--secondary); border-radius: 50%; transform: translate(-50%, -50%); }
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.164.1/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164.1/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div class="loading-screen" id="loadingScreen">
    <div class="logo">NAJ</div>
    <div class="loading-text">Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ø§Ù„Ù… Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ...</div>
    <div class="loading-bar"><div class="loading-progress" id="loadingProgress"></div></div>
  </div>

  <div id="app"></div>

  <div class="ui-container">
    <div class="crosshair"></div>
    <div class="interaction-prompt" id="interactionPrompt"></div>
    <div class="control-panel visible" id="controlPanel">
        <div class="panel-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø§Ù…Ù„Ø©</div>
        <div class="panel-group">
            <div class="panel-row">
                <span class="panel-label">Ø§Ù„ÙˆÙ‚Øª</span>
                <input type="range" min="5" max="19" step="0.1" value="9.5" class="panel-slider" id="timeSlider">
            </div>
             <div class="panel-row">
                <button class="panel-btn" id="rainBtn">â˜” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø·Ø±</button>
                <button class="panel-btn" id="interiorBtn">ğŸ’º Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</button>
            </div>
        </div>
        <div class="panel-group">
            <div class="panel-title">ØªØ®ØµÙŠØµ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</div>
            <div class="color-swatches" id="colorSwatches"></div>
            <button class="panel-btn" id="headlightsBtn">ğŸ’¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø¨ÙŠØ­</button>
        </div>
    </div>
  </div>
  
  <div class="mobile-controls" id="mobileControls">
      <div class="joystick-zone" id="move-joystick"><div class="joystick-base"><div class="joystick-stick"></div></div></div>
      <div class="joystick-zone" id="look-joystick"><div class="joystick-base"><div class="joystick-stick"></div></div></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
  <script type="module">
    import * as THREE from "three";
    import { GLTFLoader } from "three/addons/loaders/GLTFLoader.js";
    import { DRACOLoader } from "three/addons/loaders/DRACOLoader.js";
    import { Water } from 'three/addons/objects/Water.js';
    import { Sky } from 'three/addons/objects/Sky.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { SSRPass } from 'three/addons/postprocessing/SSRPass.js';
    import { GodRaysPass } from 'https://unpkg.com/three-good-god-rays-pass@1.2.1/build/GodRaysPass.js';

    class UltimateShowroom {
      constructor() {
        this.initDOM();
        this.initCore();
        this.initAudio();
        this.initLoaders();
        this.initEnvironment();
        this.initPlayer();
        this.initControls();
        this.initPostProcessing();
        this.loadAssets();
        this.animate();
      }

      initDOM() {
        this.dom = {
          app: document.getElementById('app'),
          loadingScreen: document.getElementById('loadingScreen'),
          loadingProgress: document.getElementById('loadingProgress'),
          interactionPrompt: document.getElementById('interactionPrompt'),
          controlPanel: document.getElementById('controlPanel'),
          timeSlider: document.getElementById('timeSlider'),
          rainBtn: document.getElementById('rainBtn'),
          interiorBtn: document.getElementById('interiorBtn'),
          colorSwatches: document.getElementById('colorSwatches'),
          headlightsBtn: document.getElementById('headlightsBtn'),
          mobileControls: document.getElementById('mobileControls'),
        };
      }

      initCore() {
        this.scene = new THREE.Scene();
        this.renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.outputColorSpace = THREE.SRGBColorSpace;
        this.renderer.toneMapping = THREE.ACESFilmicToneMapping;
        this.renderer.shadowMap.enabled = true;
        this.renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        this.dom.app.appendChild(this.renderer.domElement);

        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 20000);
        this.clock = new THREE.Clock();
        this.raycaster = new THREE.Raycaster();
        this.mouse = new THREE.Vector2();
        this.state = { inCar: false, headlightsOn: false, isRaining: false };
      }

      initAudio() {
        this.audio = {
            engine: new Tone.Player({ url: "https://cdn.freesound.org/previews/573/573420_7994920-lq.mp3", loop: true }).toDestination(),
            rain: new Tone.Player({ url: "https://cdn.freesound.org/previews/343/343330_5121236-lq.mp3", loop: true, volume: -10 }).toDestination(),
            doorOpen: new Tone.Player("https://cdn.freesound.org/previews/211/211985_2339069-lq.mp3").toDestination(),
            doorClose: new Tone.Player("https://cdn.freesound.org/previews/211/211984_2339069-lq.mp3").toDestination(),
            uiClick: new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 6, envelope: { attack: 0.001, decay: 0.2, sustain: 0 } }).toDestination(),
        };
      }

      initLoaders() {
        this.loadingManager = new THREE.LoadingManager(
          () => this.dom.loadingScreen.classList.add('hidden'),
          (url, loaded, total) => { this.dom.loadingProgress.style.width = `${(loaded / total) * 100}%`; }
        );
        const dracoLoader = new DRACOLoader(this.loadingManager).setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
        this.gltfLoader = new GLTFLoader(this.loadingManager).setDRACOLoader(dracoLoader);
        this.textureLoader = new THREE.TextureLoader(this.loadingManager);
      }

      initEnvironment() {
        // Sky
        this.sky = new Sky();
        this.sky.scale.setScalar(10000);
        this.scene.add(this.sky);
        this.sun = new THREE.Vector3();
        this.updateSunPosition(this.dom.timeSlider.value);

        // Water
        const waterGeometry = new THREE.PlaneGeometry(10000, 10000);
        this.water = new Water(waterGeometry, {
            textureWidth: 512, textureHeight: 512,
            waterNormals: this.textureLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/waternormals.jpg', (texture) => {
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
            }),
            sunDirection: new THREE.Vector3(), sunColor: 0xffffff,
            waterColor: 0x001e0f, distortionScale: 3.7,
            fog: this.scene.fog !== undefined
        });
        this.water.rotation.x = -Math.PI / 2;
        this.scene.add(this.water);

        // Terrain
        const terrainGeometry = new THREE.PlaneGeometry(500, 500, 100, 100);
        const pos = terrainGeometry.attributes.position;
        for (let i = 0; i < pos.count; i++){
            const y = 5 * Math.sin(pos.getX(i) / 10) * Math.cos(pos.getZ(i) / 10);
            pos.setY(i, y);
        }
        terrainGeometry.computeVertexNormals();
        const terrainMaterial = new THREE.MeshStandardMaterial({ color: 0x40513B, roughness: 0.8 });
        const terrain = new THREE.Mesh(terrainGeometry, terrainMaterial);
        terrain.receiveShadow = true;
        this.scene.add(terrain);

        // Rain
        const rainCount = 15000;
        const rainGeo = new THREE.BufferGeometry();
        const positions = new Float32Array(rainCount * 3);
        for(let i=0; i < rainCount; i++) {
            positions[i*3] = Math.random() * 400 - 200;
            positions[i*3+1] = Math.random() * 500 - 250;
            positions[i*3+2] = Math.random() * 400 - 200;
        }
        rainGeo.setAttribute('position', new THREE.BufferAttribute(positions, 3));
        const rainMaterial = new THREE.PointsMaterial({ color: 0xaaaaaa, size: 0.1, transparent: true });
        this.rain = new THREE.Points(rainGeo, rainMaterial);
        this.rain.visible = false;
        this.scene.add(this.rain);
      }

      updateSunPosition(time) {
          const phi = THREE.MathUtils.degToRad(90 - (time - 5) / 14 * 180); // 5am to 7pm
          const theta = THREE.MathUtils.degToRad(180);
          this.sun.setFromSphericalCoords(1, phi, theta);
          this.sky.material.uniforms['sunPosition'].value.copy(this.sun);
          this.water.material.uniforms['sunDirection'].value.copy(this.sun).normalize();
          if(this.godRaysPass) this.godRaysPass.setLightSun(this.sun);
      }
      
      initPlayer() {
        this.player = {
            velocity: new THREE.Vector3(),
            speed: 8.0,
            runMultiplier: 2.0,
            jumpForce: 10.0,
            gravity: -25.0,
            onGround: false,
            input: { forward: 0, right: 0, run: false, jump: false },
            isLooking: false
        };
        this.camera.position.set(0, 2, 10);
      }

      initControls() {
        // Desktop
        this.dom.app.addEventListener('mousedown', (e) => { if (e.button === 2) { this.player.isLooking = true; this.dom.app.classList.add('looking'); } });
        this.dom.app.addEventListener('mouseup', (e) => { if (e.button === 2) { this.player.isLooking = false; this.dom.app.classList.remove('looking'); } });
        this.dom.app.addEventListener('mousemove', (e) => {
          if (this.player.isLooking) {
            this.camera.rotation.y -= e.movementX * 0.002;
            this.camera.rotation.x -= e.movementY * 0.002;
            this.camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, this.camera.rotation.x));
          }
           this.mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
           this.mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        });
        this.dom.app.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', (e) => this.handleKey(e.code, true));
        document.addEventListener('keyup', (e) => this.handleKey(e.code, false));

        // UI Listeners
        this.dom.timeSlider.addEventListener('input', (e) => this.updateSunPosition(e.target.value));
        this.dom.rainBtn.addEventListener('click', () => this.toggleRain());
        this.dom.interiorBtn.addEventListener('click', () => this.toggleInteriorView());
        this.dom.headlightsBtn.addEventListener('click', () => this.toggleHeadlights());
        this.dom.app.addEventListener('click', (e) => this.handleInteractionClick(e));
      }

      handleKey(code, isDown) {
        switch(code) {
          case 'KeyW': this.player.input.forward = isDown ? 1 : 0; break;
          case 'KeyS': this.player.input.forward = isDown ? -1 : 0; break;
          case 'KeyA': this.player.input.right = isDown ? -1 : 0; break;
          case 'KeyD': this.player.input.right = isDown ? 1 : 0; break;
          case 'ShiftLeft': this.player.input.run = isDown; break;
          case 'Space': if (isDown) this.player.input.jump = true; break;
        }
      }
      
      initPostProcessing() {
        this.composer = new EffectComposer(this.renderer);
        this.composer.addPass(new RenderPass(this.scene, this.camera));
        
        this.ssrPass = new SSRPass({
            renderer: this.renderer, scene: this.scene, camera: this.camera,
            width: window.innerWidth, height: window.innerHeight,
            groundReflector: null, selects: null
        });
        this.composer.addPass(this.ssrPass);
        
        this.composer.addPass(new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 0.5, 0.4, 0.85));
        
        this.godRaysPass = new GodRaysPass(this.scene, this.camera, this.renderer, {
            sun: this.sun, density: 0.96, maxDensity: 0.98,
        });
        this.composer.addPass(this.godRaysPass);
      }

      loadAssets() {
        this.gltfLoader.load('https://raw.githubusercontent.com/kanawattown-a11y/12/f91219369eb76bb2e445f95abaa61860e3b886dd/naj.glb', (gltf) => {
          this.car = { model: gltf.scene, doors: [], headlights: [] };
          this.car.model.scale.setScalar(1.2);
          this.car.model.position.y = 0.5;
          this.scene.add(this.car.model);

          this.car.model.traverse(child => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
              if (child.material.name === 'paint_main') this.car.paintMaterial = child.material;
              if (child.name.toLowerCase().includes('door')) {
                  const pivot = new THREE.Object3D();
                  const doorWrapper = new THREE.Object3D();
                  child.getWorldPosition(doorWrapper.position);
                  pivot.position.copy(doorWrapper.position);
                  pivot.add(doorWrapper);
                  doorWrapper.add(child);
                  child.position.set(0,0,0);
                  this.car.model.add(pivot);
                  this.car.doors.push({ mesh: child, wrapper: doorWrapper, pivot: pivot, isOpen: false, openAngle: child.name.includes('_l') ? Math.PI / 2.5 : -Math.PI / 2.5 });
              }
              if (child.name.toLowerCase().includes('headlight_glass')) {
                const light = new THREE.SpotLight(0xffffff, 0, 20, Math.PI / 4, 0.5, 2);
                light.position.set(0, 0.5, 2.2);
                child.add(light);
                light.target.position.set(0, 0, 10);
                child.add(light.target);
                this.car.headlights.push(light);
              }
            }
          });
          this.populateColorSwatches();
        });
      }

      populateColorSwatches() {
        const colors = [0xff0000, 0x0000ff, 0x00ff00, 0xffff00, 0xffa500, 0x800080, 0x000000, 0xffffff, 0x808080, 0x4d6172];
        colors.forEach((color, i) => {
          const swatch = document.createElement('div');
          swatch.className = 'swatch' + (i === 8 ? ' active' : '');
          swatch.style.background = `#${new THREE.Color(color).getHexString()}`;
          swatch.addEventListener('click', () => {
            if (this.car.paintMaterial) this.car.paintMaterial.color.set(color);
            this.audio.uiClick.triggerAttackRelease("C4", "8n");
            document.querySelector('.swatch.active')?.classList.remove('active');
            swatch.classList.add('active');
          });
          this.dom.colorSwatches.appendChild(swatch);
        });
      }

      handleInteractionClick(event) {
        if (this.player.isLooking || !this.hoveredObject) return;
        
        const door = this.car.doors.find(d => d.mesh === this.hoveredObject);
        if (door) {
            door.isOpen = !door.isOpen;
            door.isOpen ? this.audio.doorOpen.start() : this.audio.doorClose.start();
        }
      }

      toggleRain() {
        this.state.isRaining = !this.state.isRaining;
        this.rain.visible = this.state.isRaining;
        this.dom.rainBtn.classList.toggle('active', this.state.isRaining);
        this.dom.rainBtn.innerHTML = this.state.isRaining ? 'â˜€ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø·Ø±' : 'â˜” ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø·Ø±';
        this.state.isRaining ? this.audio.rain.start() : this.audio.rain.stop();
      }

      toggleInteriorView() {
        this.state.inCar = !this.state.inCar;
        this.dom.interiorBtn.classList.toggle('active', this.state.inCar);
        this.dom.interiorBtn.innerHTML = this.state.inCar ? 'ğŸšª Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„Ø³ÙŠØ§Ø±Ø©' : 'ğŸ’º Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©';
        if (this.state.inCar) {
            this.audio.engine.start();
            this.car.model.getWorldPosition(this.camera.position);
            this.camera.position.set(-0.5, 1.5, 0.5); // Driver seat position relative to car
        } else {
            this.audio.engine.stop();
            this.car.model.getWorldPosition(this.camera.position);
            this.camera.position.x += 5; // Exit position
        }
      }
      
      toggleHeadlights() {
        this.state.headlightsOn = !this.state.headlightsOn;
        this.dom.headlightsBtn.classList.toggle('active', this.state.headlightsOn);
        this.car.headlights.forEach(light => light.intensity = this.state.headlightsOn ? 200 : 0);
      }

      updatePlayer(deltaTime) {
        if (this.state.inCar) return;

        // Gravity
        if (!this.player.onGround) this.player.velocity.y += this.player.gravity * deltaTime;
        
        // Movement
        const speed = this.player.speed * (this.player.input.run ? this.player.runMultiplier : 1);
        const moveDir = new THREE.Vector3(this.player.input.right, 0, this.player.input.forward).normalize();
        const movement = new THREE.Vector3();
        if (moveDir.length() > 0) {
            const forward = new THREE.Vector3();
            this.camera.getWorldDirection(forward);
            forward.y = 0;
            forward.normalize();
            const right = new THREE.Vector3().crossVectors(this.camera.up, forward);
            movement.addScaledVector(forward, moveDir.z * speed * deltaTime);
            movement.addScaledVector(right, moveDir.x * speed * deltaTime);
        }
        this.camera.position.add(movement);

        // Jump
        if (this.player.input.jump && this.player.onGround) {
            this.player.velocity.y = this.player.jumpForce;
            this.player.onGround = false;
        }
        this.player.input.jump = false;
        
        this.camera.position.y += this.player.velocity.y * deltaTime;

        // Ground collision
        if (this.camera.position.y < 1.8) {
            this.camera.position.y = 1.8;
            this.player.velocity.y = 0;
            this.player.onGround = true;
        }
      }

      updateInteractions() {
        this.raycaster.setFromCamera(this.mouse, this.camera);
        const doorMeshes = this.car.doors.map(d => d.mesh);
        const intersects = this.raycaster.intersectObjects(doorMeshes);

        if (intersects.length > 0 && intersects[0].distance < 5) {
            this.hoveredObject = intersects[0].object;
            this.dom.interactionPrompt.textContent = `Ø§Ù†Ù‚Ø± Ù„ÙØªØ­/Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ø§Ø¨`;
            this.dom.interactionPrompt.classList.add('visible');
        } else {
            this.hoveredObject = null;
            this.dom.interactionPrompt.classList.remove('visible');
        }
      }
      
      animate() {
        requestAnimationFrame(() => this.animate());
        const deltaTime = this.clock.getDelta();
        
        this.water.material.uniforms['time'].value += 1.0 / 60.0;
        
        if(this.state.isRaining) {
            const positions = this.rain.geometry.attributes.position.array;
            for (let i = 0; i < positions.length; i+=3) {
                positions[i+1] -= 50 * deltaTime;
                if (positions[i+1] < -200) positions[i+1] = 200;
            }
            this.rain.geometry.attributes.position.needsUpdate = true;
        }

        if (this.car) {
            this.updateInteractions();
            this.car.doors.forEach(door => {
                const targetAngle = door.isOpen ? door.openAngle : 0;
                door.pivot.rotation.y = THREE.MathUtils.lerp(door.pivot.rotation.y, targetAngle, deltaTime * 5);
            });
        }
        
        this.updatePlayer(deltaTime);
        this.composer.render();
      }
    }

    window.addEventListener('load', () => new UltimateShowroom());
  </script>
</body>
</html>
