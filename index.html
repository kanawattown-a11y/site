<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <!-- Allow pinch-zoom on mobile for accessibility -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>معرض نجوم الجزيرة الافتراضي — v2 (Mobile-First & Performance)</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1724;
      --glass:rgba(255,255,255,0.06);
      --glass-border:rgba(255,255,255,0.12);
      --text:#fff;
      --accent:linear-gradient(135deg,#667eea,#764ba2);
      --safe-top: env(safe-area-inset-top);
    }

    *{box-sizing:border-box}
    html,body{height:100%;width:100%;margin:0;padding:0;background:var(--bg);font-family:'Cairo',system-ui,Segoe UI,Roboto,Arial;color:var(--text);-webkit-font-smoothing:antialiased}

    /* Canvas container stretches but respects safe-area on iOS */
    #app{position:fixed;inset:0;padding-top:var(--safe-top);}
    canvas{display:block;width:100%;height:100%;touch-action:none}

    /* Lightweight, mobile-first UI */
    .ui-overlay{position:fixed;inset:0;pointer-events:none;z-index:40}
    .ui-overlay>*{pointer-events:auto}

    .top-bar{position:fixed;top:10px;left:10px;right:10px;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .brand{background:var(--glass);border:1px solid var(--glass-border);padding:8px 12px;border-radius:10px;display:flex;gap:8px;align-items:center}
    .brand .logo{width:36px;height:36px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:900}
    .brand .title{font-weight:700}

    .controls{position:fixed;right:12px;top:12px;display:flex;gap:8px;flex-wrap:wrap}
    .btn{background:var(--glass);border:1px solid var(--glass-border);padding:8px 12px;border-radius:10px;font-weight:600}
    .btn.primary{background:linear-gradient(135deg,#4facfe,#00f2fe);color:#05263b}

    /* Welcome modal (centered) */
    .welcome{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:18px;z-index:60}
    .welcome .card{max-width:640px;width:100%;background:rgba(255,255,255,0.03);border:1px solid var(--glass-border);padding:20px;border-radius:14px;text-align:center}
    .features{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:10px;margin-top:14px}

    /* Mobile controls: joystick & action buttons */
    .mobile-controls{position:fixed;inset:0;z-index:50;pointer-events:none}
    .mobile-controls.active{pointer-events:auto}
    .joystick{position:absolute;bottom:24px;left:18px;width:100px;height:100px;border-radius:50%;background:var(--glass);display:flex;align-items:center;justify-content:center;border:1px solid var(--glass-border)}
    .joystick .handle{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#4facfe,#00f2fe)}
    .actions{position:absolute;right:18px;bottom:24px;display:flex;flex-direction:column;gap:8px}
    .actions .action{min-width:64px;padding:10px;border-radius:10px;background:var(--glass);border:1px solid var(--glass-border);text-align:center}

    /* status & performance - small and unobtrusive */
    .status{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,0.4);padding:8px 10px;border-radius:10px;font-family:monospace;font-size:12px}

    /* responsive tweaks */
    @media (max-width:768px){
      .welcome .card{padding:14px}
      .brand .title{font-size:13px}
      .joystick{width:92px;height:92px}
      .joystick .handle{width:44px;height:44px}
    }

    @media (max-width:420px){
      .brand .title{display:none}
      .controls{right:8px;top:8px}
    }
  </style>

  <script type="importmap">
  {
    "imports":{
      "three":"https://unpkg.com/three@0.160.0/build/three.module.js",
      "three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"
    }
  }
  </script>
</head>
<body>
  <div id="app"></div>

  <div class="ui-overlay">
    <div class="top-bar">
      <div class="brand"><div class="logo">NAJ</div><div class="title">نجوم الجزيرة - المعرض الافتراضي</div></div>
      <div class="controls">
        <button class="btn" id="openSettings">الإعدادات</button>
        <button class="btn primary" id="enterExperience">دخول</button>
      </div>
    </div>

    <div class="welcome" id="welcomeScreen">
      <div class="card">
        <h2>مرحباً بك في معرض نجوم الجزيرة</h2>
        <p>نسخة محسّنة للجوال — أداء أسرع، إعدادات أوتوماتيكية للأجهزة المحمولة، وتحكم لمسي مريح.</p>
        <div class="features">
          <div>تحكم لمسي ذكي</div>
          <div>جودة متغيرة حسب الجهاز</div>
          <div>تحميل تدريجي للنماذج</div>
          <div>واجهة مخصّصة للموبايل</div>
        </div>
        <div style="margin-top:14px;display:flex;gap:8px;justify-content:center">
          <button class="btn primary" id="welcomeEnter">ابدأ الآن</button>
          <button class="btn" id="welcomeSettings">تعديل الإعدادات</button>
        </div>
      </div>
    </div>

    <div class="mobile-controls" id="mobileControls">
      <div class="joystick" id="movementJoystick"><div class="handle" id="movementHandle"></div></div>
      <div class="actions"><div class="action" id="jumpBtn">قفز</div><div class="action" id="runBtn">ركض</div></div>
    </div>

    <div class="status" id="statusBar">FPS: <span id="fps">0</span></div>
  </div>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
    import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';

    // Simple, pragmatic config with mobile-first handling
    const CONFIG = {
      MODEL_URL: 'https://raw.githubusercontent.com/kanawattown-a11y/12/f91219369eb76bb2e445f95abaa61860e3b886dd/naj.glb',
      MAX_PIXEL_RATIO_DESKTOP: 2,
      MAX_PIXEL_RATIO_MOBILE: 1,
      SHADOW_MAP_SIZE_DESKTOP: 2048,
      SHADOW_MAP_SIZE_MOBILE: 512,
      TOUCH_SENS: 1.5
    };

    const IS_MOBILE = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.maxTouchPoints && navigator.maxTouchPoints>1);

    // Core three.js setup
    const container = document.getElementById('app');
    const renderer = new THREE.WebGLRenderer({antialias: !IS_MOBILE, alpha:false});
    const DPR = IS_MOBILE ? Math.min(window.devicePixelRatio || 1, CONFIG.MAX_PIXEL_RATIO_MOBILE) : Math.min(window.devicePixelRatio || 1, CONFIG.MAX_PIXEL_RATIO_DESKTOP);
    renderer.setPixelRatio(DPR);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    container.appendChild(renderer.domElement);

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b1220);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
    camera.position.set(0,1.6,3);

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff,0x444444,0.4);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff,1.0);
    dir.position.set(20,40,20);
    dir.castShadow = true;
    const mapSize = IS_MOBILE?CONFIG.SHADOW_MAP_SIZE_MOBILE:CONFIG.SHADOW_MAP_SIZE_DESKTOP;
    dir.shadow.mapSize.set(mapSize,mapSize);
    scene.add(dir);

    // Ground (cheap) that receives shadow
    const ground = new THREE.Mesh(new THREE.PlaneGeometry(1000,1000), new THREE.MeshStandardMaterial({color:0x2d2f36,roughness:0.9,metalness:0.0}));
    ground.rotation.x = -Math.PI/2;
    ground.receiveShadow = true;
    scene.add(ground);

    // Loaders with DRACO for compressed glb
    const loadingManager = new THREE.LoadingManager();
    const draco = new DRACOLoader(loadingManager);
    draco.setDecoderPath('https://www.gstatic.com/draco/v1/decoders/');
    const gltfLoader = new GLTFLoader(loadingManager);
    gltfLoader.setDRACOLoader(draco);

    // Lightweight progressive loading: first low LOD mesh (if available), then full model
    function loadModel(url){
      return new Promise((resolve,reject)=>{
        gltfLoader.load(url, gltf=>resolve(gltf), xhr=>{
          const el = document.getElementById('statusBar');
          if(el){el.textContent = 'تحميل: ' + Math.round((xhr.loaded/xhr.total||0)*100) + '%';}
        }, reject);
      });
    }

    let car = null;
    loadingManager.onLoad = ()=>{
      // hide welcome
      document.getElementById('welcomeScreen').style.display = 'none';
      if(IS_MOBILE) document.getElementById('mobileControls').classList.add('active');
    };

    // Material fixer: ensure standard PBR and clamp heavy maps
    function fixMaterial(mesh){
      if(mesh.isMesh){
        let mat = mesh.material;
        if(!mat) return;
        if(!mat.isMeshStandardMaterial && !mat.isMeshPhysicalMaterial){
          mesh.material = new THREE.MeshStandardMaterial({map:mat.map,color:mat.color});
        }
        if(mesh.material.map){
          mesh.material.map.anisotropy = Math.min(renderer.capabilities.getMaxAnisotropy(),4);
          mesh.material.map.generateMipmaps = true;
        }
        mesh.castShadow = true; mesh.receiveShadow = true;
      }
    }

    // load model and add to scene
    (async ()=>{
      try{
        const gltf = await loadModel(CONFIG.MODEL_URL);
        car = gltf.scene || gltf.scenes[0];
        car.traverse(fixMaterial);
        car.position.set(0,0,0);
        car.scale.setScalar(1.0);
        scene.add(car);
      }catch(err){
        console.warn('فشل تحميل النموذج:',err);
      }
    })();

    // Controls: pointer lock for desktop; simple touch-look for mobile
    let controls = null;
    if(!IS_MOBILE){
      controls = new PointerLockControls(camera, renderer.domElement);
      document.addEventListener('click', ()=>{ if(!controls.isLocked) controls.lock(); });
      scene.add(controls.getObject());
    } else {
      // show subtle tilt/drag handling later — we use a simple camera orbit with touch
      let last = null;
      let touching = false;
      renderer.domElement.addEventListener('touchstart', e=>{ if(e.touches.length===1){touching=true; last = {x:e.touches[0].clientX,y:e.touches[0].clientY};} });
      renderer.domElement.addEventListener('touchmove', e=>{
        if(!touching||e.touches.length!==1) return; e.preventDefault();
        const dx = (e.touches[0].clientX - last.x)/window.innerWidth;
        const dy = (e.touches[0].clientY - last.y)/window.innerHeight;
        last = {x:e.touches[0].clientX,y:e.touches[0].clientY};
        camera.rotation.y -= dx * CONFIG.TOUCH_SENS;
        camera.rotation.x -= dy * CONFIG.TOUCH_SENS;
        camera.rotation.x = Math.max(-Math.PI/2+0.1, Math.min(Math.PI/2-0.1,camera.rotation.x));
      },{passive:false});
      renderer.domElement.addEventListener('touchend', ()=>{touching=false; last=null});
    }

    // Basic player-like movement: forward/back via keyboard or mobile joystick
    const velocity = new THREE.Vector3();
    const keys = {};
    window.addEventListener('keydown', e=>keys[e.code]=true);
    window.addEventListener('keyup', e=>keys[e.code]=false);

    // Mobile joystick: basic implementation
    const movementHandle = document.getElementById('movementHandle');
    const movementJoystick = document.getElementById('movementJoystick');
    if(movementJoystick){
      let active=false, origin=null, maxDist=movementJoystick.clientWidth/2 - movementHandle.clientWidth/2;
      movementJoystick.addEventListener('touchstart', e=>{e.preventDefault(); active=true; origin={x:e.touches[0].clientX,y:e.touches[0].clientY}} ,{passive:false});
      movementJoystick.addEventListener('touchmove', e=>{if(!active) return; e.preventDefault(); const dx = e.touches[0].clientX - origin.x; const dy = e.touches[0].clientY - origin.y; const dist = Math.min(Math.hypot(dx,dy), maxDist); const nx = dx/dist||0; const ny=dy/dist||0; movementHandle.style.transform = `translate(${dx}px, ${dy}px)`; velocity.x = (dx/maxDist)*2; velocity.z = (dy/maxDist)*2;},{passive:false});
      movementJoystick.addEventListener('touchend', e=>{active=false; movementHandle.style.transform='translate(0,0)'; velocity.x=0; velocity.z=0;},{passive:false});
    }

    // Resize
    window.addEventListener('resize', ()=>{
      const dpr = IS_MOBILE ? Math.min(window.devicePixelRatio||1, CONFIG.MAX_PIXEL_RATIO_MOBILE) : Math.min(window.devicePixelRatio||1, CONFIG.MAX_PIXEL_RATIO_DESKTOP);
      renderer.setPixelRatio(dpr);
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Animation loop + light, fps tracking
    let lastTime = performance.now(); let frames = 0; let fpsEl = document.getElementById('fps');
    function animate(){
      requestAnimationFrame(animate);
      const now = performance.now(); const dt = (now-lastTime)/1000; lastTime=now; frames++;
      if(now%1000<50){ fpsEl.textContent = Math.round(frames/(dt||1)); frames=0; }

      // Simple movement: WASD
      const forward = keys['KeyW'] || keys['ArrowUp'];
      const back = keys['KeyS'] || keys['ArrowDown'];
      const left = keys['KeyA'] || keys['ArrowLeft'];
      const right = keys['KeyD'] || keys['ArrowRight'];
      const moveSpeed = IS_MOBILE ? 2.5 : 5.0;
      const moveVec = new THREE.Vector3();
      if(forward) moveVec.z -= 1; if(back) moveVec.z += 1; if(left) moveVec.x -= 1; if(right) moveVec.x += 1;
      if(moveVec.length()>0) moveVec.normalize().multiplyScalar(moveSpeed);
      // combine with joystick velocity
      camera.position.x += (moveVec.x + velocity.x) * dt;
      camera.position.z += (moveVec.z + velocity.z) * dt;

      renderer.render(scene,camera);
    }
    animate();

    // UI wiring
    document.getElementById('welcomeEnter').addEventListener('click', ()=>{document.getElementById('welcomeScreen').style.display='none'; if(IS_MOBILE) document.getElementById('mobileControls').classList.add('active');});
    document.getElementById('enterExperience').addEventListener('click', ()=>{document.getElementById('welcomeScreen').style.display='none'; if(IS_MOBILE) document.getElementById('mobileControls').classList.add('active'); else { if(controls) controls.lock(); }});

    // Quick accessibility: allow toggling welcome
    document.getElementById('openSettings').addEventListener('click', ()=>{alert('لوحة الإعدادات: قيد التطوير — أخبرني بأي إعدادات تريدها!')});

    // Expose for debugging
    window._showroom = {scene,camera,renderer};
  </script>
</body>
</html>
