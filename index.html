<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>معرض نجوم الجزيرة الافتراضي - تجربة ثلاثية الأبعاد متقدمة</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #1e40af;
      --secondary: #f59e0b;
      --accent: #06b6d4;
      --success: #10b981;
      --bg-dark: #0f172a;
      --bg-light: #1e293b;
      --text-light: #f8fafc;
      --text-muted: #cbd5e1;
      --glass: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --glass-strong: rgba(255, 255, 255, 0.15);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, var(--bg-dark) 0%, var(--primary) 100%);
      font-family: 'Cairo', system-ui, sans-serif;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    #app {
      position: fixed;
      inset: 0;
    }

    canvas {
      display: block;
    }

    /* Loading Screen */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, var(--bg-dark) 0%, var(--primary) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      transition: opacity 0.8s ease-out;
    }

    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .logo {
      width: 140px;
      height: 140px;
      background: var(--glass-strong);
      border: 3px solid var(--glass-border);
      border-radius: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 24px;
      backdrop-filter: blur(15px);
      animation: logoFloat 3s ease-in-out infinite;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
    }

    @keyframes logoFloat {
      0%, 100% { transform: translateY(0px) scale(1); }
      50% { transform: translateY(-10px) scale(1.05); }
    }

    .loading-text {
      color: var(--text-light);
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 12px;
      text-align: center;
    }

    .loading-subtitle {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 20px;
      text-align: center;
    }

    .loading-bar {
      width: 250px;
      height: 6px;
      background: var(--glass);
      border-radius: 3px;
      overflow: hidden;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .loading-progress {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary), var(--accent), var(--success));
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
      animation: progressGlow 2s ease-in-out infinite;
    }

    @keyframes progressGlow {
      0%, 100% { box-shadow: 0 0 5px rgba(245, 158, 11, 0.5); }
      50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.8); }
    }

    /* UI Container */
    .ui {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 100;
    }

    /* Header HUD */
    .header-hud {
      position: absolute;
      top: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      pointer-events: auto;
      gap: 20px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 15px;
      background: var(--glass-strong);
      border: 2px solid var(--glass-border);
      border-radius: 15px;
      padding: 12px 20px;
      backdrop-filter: blur(15px);
      color: var(--text-light);
      font-weight: 600;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
    }

    .brand:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: white;
      font-size: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .controls-info {
      background: var(--glass-strong);
      border: 2px solid var(--glass-border);
      border-radius: 15px;
      padding: 15px 20px;
      backdrop-filter: blur(15px);
      color: var(--text-light);
      font-size: 14px;
      max-width: 450px;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }

    .controls-info.show {
      display: block;
      animation: slideInRight 0.5s ease-out;
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Environment Controls */
    .env-controls {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      pointer-events: auto;
    }

    .env-btn {
      background: var(--glass);
      border: 2px solid var(--glass-border);
      border-radius: 12px;
      padding: 12px 16px;
      color: var(--text-light);
      cursor: pointer;
      backdrop-filter: blur(15px);
      transition: all 0.3s ease;
      font-size: 13px;
      font-weight: 600;
      min-width: 90px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .env-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .env-btn:hover {
      background: var(--glass-border);
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .env-btn:hover::before {
      left: 100%;
    }

    .env-btn.active {
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      color: white;
      border-color: var(--secondary);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
    }

    /* Welcome Screen */
    .welcome-screen {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(15px);
      pointer-events: auto;
    }

    .welcome-card {
      width: min(650px, 90vw);
      background: var(--glass-strong);
      border: 2px solid var(--glass-border);
      border-radius: 25px;
      padding: 50px;
      backdrop-filter: blur(25px);
      text-align: center;
      animation: welcomeSlideUp 0.8s ease-out;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    @keyframes welcomeSlideUp {
      from {
        opacity: 0;
        transform: translateY(50px) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .welcome-title {
      font-size: 32px;
      font-weight: 700;
      color: var(--text-light);
      margin: 0 0 20px;
      background: linear-gradient(135deg, var(--text-light), var(--accent), var(--secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: titleGlow 3s ease-in-out infinite;
    }

    @keyframes titleGlow {
      0%, 100% { filter: brightness(1); }
      50% { filter: brightness(1.2); }
    }

    .welcome-subtitle {
      font-size: 18px;
      color: var(--text-muted);
      margin: 0 0 30px;
      line-height: 1.7;
    }

    .features-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .feature {
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .feature:hover {
      background: rgba(255, 255, 255, 0.12);
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .feature-icon {
      font-size: 28px;
      margin-bottom: 12px;
      display: block;
    }

    .feature-text {
      font-size: 15px;
      color: var(--text-muted);
      font-weight: 500;
    }

    .action-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 40px;
      flex-wrap: wrap;
    }

    .btn {
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      color: white;
      border: none;
      border-radius: 15px;
      padding: 16px 30px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      min-width: 140px;
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
      transition: left 0.5s ease;
    }

    .btn:hover {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn-secondary {
      background: var(--glass-strong);
      border: 2px solid var(--glass-border);
      color: var(--text-light);
    }

    .btn-secondary:hover {
      background: var(--glass-border);
    }

    /* Crosshair */
    .crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 24px;
      height: 24px;
      margin-left: -12px;
      margin-top: -12px;
      border: 3px solid rgba(255, 255, 255, 0.9);
      border-radius: 50%;
      display: none;
      pointer-events: none;
      animation: crosshairPulse 2.5s infinite;
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
    }

    @keyframes crosshairPulse {
      0%, 100% { 
        opacity: 0.8; 
        transform: translate(-50%, -50%) scale(1);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
      }
      50% { 
        opacity: 1; 
        transform: translate(-50%, -50%) scale(1.2);
        box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
      }
    }

    /* Mobile Controls */
    .mobile-controls {
      position: fixed;
      inset: 0;
      pointer-events: none;
      display: none;
    }

    .mobile-controls.show {
      display: block;
    }

    .joystick {
      position: absolute;
      border-radius: 50%;
      background: var(--glass-strong);
      border: 3px solid var(--glass-border);
      backdrop-filter: blur(15px);
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: auto;
      touch-action: none;
      user-select: none;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      transition: all 0.3s ease;
    }

    .joystick:active {
      transform: scale(1.05);
    }

    .joystick-left {
      bottom: 140px;
      left: 35px;
      width: 150px;
      height: 150px;
    }

    .joystick-right {
      bottom: 160px;
      right: 35px;
      width: 110px;
      height: 110px;
    }

    .joystick-stick {
      border-radius: 50%;
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      transition: transform 0.1s ease;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .joystick-left .joystick-stick {
      width: 70px;
      height: 70px;
    }

    .joystick-right .joystick-stick {
      width: 50px;
      height: 50px;
    }

    .mobile-buttons {
      position: absolute;
      right: 35px;
      bottom: 35px;
      display: flex;
      flex-direction: column;
      gap: 15px;
      pointer-events: auto;
    }

    .mobile-btn {
      background: var(--glass-strong);
      border: 3px solid var(--glass-border);
      border-radius: 15px;
      padding: 15px 20px;
      color: var(--text-light);
      font-weight: 600;
      cursor: pointer;
      backdrop-filter: blur(15px);
      transition: all 0.2s ease;
      min-width: 90px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .mobile-btn:active {
      transform: scale(0.95);
    }

    .mobile-btn.pressed {
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      color: white;
      border-color: var(--secondary);
      box-shadow: 0 8px 25px rgba(245, 158, 11, 0.5);
    }

    /* Status Bar */
    .status-bar {
      position: absolute;
      bottom: 25px;
      left: 25px;
      background: var(--glass-strong);
      border: 2px solid var(--glass-border);
      border-radius: 15px;
      padding: 15px 20px;
      backdrop-filter: blur(15px);
      color: var(--text-light);
      font-size: 14px;
      pointer-events: auto;
      display: none;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      font-family: 'Courier New', monospace;
    }

    .status-bar.show {
      display: block;
      animation: slideInLeft 0.5s ease-out;
    }

    @keyframes slideInLeft {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Settings Panel */
    .settings-panel {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(500px, 90vw);
      background: var(--glass-strong);
      border: 2px solid var(--glass-border);
      border-radius: 20px;
      padding: 30px;
      backdrop-filter: blur(25px);
      display: none;
      pointer-events: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    .settings-panel.show {
      display: block;
      animation: settingsSlideIn 0.5s ease-out;
    }

    @keyframes settingsSlideIn {
      from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.9);
      }
      to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
      }
    }

    .settings-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--text-light);
      margin: 0 0 20px;
      text-align: center;
    }

    .setting-group {
      margin-bottom: 20px;
    }

    .setting-label {
      display: block;
      color: var(--text-light);
      font-weight: 600;
      margin-bottom: 8px;
    }

    .setting-slider {
      width: 100%;
      height: 6px;
      background: var(--glass);
      border-radius: 3px;
      outline: none;
      -webkit-appearance: none;
    }

    .setting-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, var(--secondary), var(--accent));
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-light);
      font-size: 24px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s ease;
    }

    .close-btn:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .welcome-card {
        padding: 30px;
        margin: 20px;
      }

      .welcome-title {
        font-size: 26px;
      }

      .welcome-subtitle {
        font-size: 16px;
      }

      .features-grid {
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      .action-buttons {
        flex-direction: column;
        align-items: center;
      }

      .btn {
        width: 100%;
        max-width: 250px;
      }

      .header-hud {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
      }

      .controls-info {
        max-width: none;
      }

      .joystick-left {
        width: 130px;
        height: 130px;
        bottom: 120px;
        left: 25px;
      }

      .joystick-left .joystick-stick {
        width: 60px;
        height: 60px;
      }

      .joystick-right {
        width: 100px;
        height: 100px;
        bottom: 140px;
        right: 25px;
      }

      .joystick-right .joystick-stick {
        width: 45px;
        height: 45px;
      }

      .mobile-buttons {
        right: 25px;
        bottom: 25px;
      }
    }

    @media (max-width: 480px) {
      .welcome-card {
        padding: 25px;
      }

      .welcome-title {
        font-size: 22px;
      }

      .brand {
        font-size: 14px;
        padding: 10px 15px;
      }

      .brand-icon {
        width: 35px;
        height: 35px;
        font-size: 14px;
      }

      .features-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Particle Effects */
    .particles {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      width: 4px;
      height: 4px;
      background: rgba(255, 255, 255, 0.6);
      border-radius: 50%;
      animation: float 6s infinite linear;
    }

    @keyframes float {
      0% {
        transform: translateY(100vh) rotate(0deg);
        opacity: 0;
      }
      10% {
        opacity: 1;
      }
      90% {
        opacity: 1;
      }
      100% {
        transform: translateY(-10vh) rotate(360deg);
        opacity: 0;
      }
    }
  </style>

  <script type="importmap">
  {
    "imports": {
      "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
    }
  }
  </script>
</head>
<body>
  <!-- Particle Background -->
  <div class="particles" id="particles"></div>

  <!-- Loading Screen -->
  <div class="loading-screen" id="loadingScreen">
    <div class="logo">NAJ</div>
    <div class="loading-text">جاري تحميل المعرض الافتراضي...</div>
    <div class="loading-subtitle">تجربة ثلاثية الأبعاد متقدمة</div>
    <div class="loading-bar">
      <div class="loading-progress" id="loadingProgress"></div>
    </div>
  </div>

  <!-- 3D Canvas Container -->
  <div id="app"></div>

  <!-- UI Overlay -->
  <div class="ui">
    <!-- Header -->
    <div class="header-hud">
      <div class="brand">
        <div class="brand-icon">NAJ</div>
        <div>نجوم الجزيرة - المعرض الافتراضي</div>
      </div>
      <div class="controls-info" id="controlsInfo">
        <div><strong>التحكم:</strong> WASD للحركة • الماوس للنظر • Space للقفز • Shift للركض • Esc للخروج</div>
        <div style="margin-top: 6px; font-size: 12px; opacity: 0.8;">الموبايل: عصا التحكم للحركة • اللمس للنظر • أزرار القفز والركض</div>
      </div>
    </div>

    <!-- Environment Controls -->
    <div class="env-controls" id="envControls" style="display: none;">
      <div class="env-btn active" data-env="showroom">🏢 معرض</div>
      <div class="env-btn" data-env="city">🏙️ مدينة</div>
      <div class="env-btn" data-env="desert">🏜️ صحراء</div>
      <div class="env-btn" data-env="night">🌙 ليل</div>
      <div class="env-btn" data-env="studio">💡 استوديو</div>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
      <div class="welcome-card">
        <h1 class="welcome-title">مرحباً بك في معرض نجوم الجزيرة الافتراضي</h1>
        <p class="welcome-subtitle">
          استكشف مجموعتنا من السيارات في بيئة ثلاثية الأبعاد تفاعلية متقدمة. 
          تجول بحرية واكتشف التفاصيل من جميع الزوايا مع تأثيرات بصرية مذهلة.
        </p>
        
        <div class="features-grid">
          <div class="feature">
            <div class="feature-icon">🚗</div>
            <div class="feature-text">نماذج عالية الجودة</div>
          </div>
          <div class="feature">
            <div class="feature-icon">🌍</div>
            <div class="feature-text">5 بيئات متنوعة</div>
          </div>
          <div class="feature">
            <div class="feature-icon">📱</div>
            <div class="feature-text">متوافق مع الموبايل</div>
          </div>
          <div class="feature">
            <div class="feature-icon">🎮</div>
            <div class="feature-text">تحكم متقدم</div>
          </div>
          <div class="feature">
            <div class="feature-icon">✨</div>
            <div class="feature-text">تأثيرات بصرية</div>
          </div>
          <div class="feature">
            <div class="feature-icon">⚡</div>
            <div class="feature-text">أداء محسن</div>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn" id="enterBtn">دخول المعرض</button>
          <button class="btn btn-secondary" id="settingsBtn">الإعدادات</button>
        </div>
      </div>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settingsPanel">
      <button class="close-btn" id="closeSettings">×</button>
      <h2 class="settings-title">إعدادات التجربة</h2>
      
      <div class="setting-group">
        <label class="setting-label">حساسية الماوس: <span id="sensitivityValue">1.0</span></label>
        <input type="range" class="setting-slider" id="sensitivitySlider" min="0.1" max="3.0" step="0.1" value="1.0">
      </div>
      
      <div class="setting-group">
        <label class="setting-label">سرعة الحركة: <span id="speedValue">6.0</span></label>
        <input type="range" class="setting-slider" id="speedSlider" min="2.0" max="15.0" step="0.5" value="6.0">
      </div>
      
      <div class="setting-group">
        <label class="setting-label">قوة القفز: <span id="jumpValue">12.0</span></label>
        <input type="range" class="setting-slider" id="jumpSlider" min="5.0" max="25.0" step="1.0" value="12.0">
      </div>
      
      <div class="setting-group">
        <label class="setting-label">جودة الظلال: <span id="shadowValue">عالية</span></label>
        <input type="range" class="setting-slider" id="shadowSlider" min="0" max="2" step="1" value="2">
      </div>
    </div>

    <!-- Crosshair -->
    <div class="crosshair" id="crosshair"></div>

    <!-- Status Bar -->
    <div class="status-bar" id="statusBar">
      <div>الموضع: <span id="positionInfo">0, 0, 0</span> | البيئة: <span id="currentEnv">معرض</span> | FPS: <span id="fpsInfo">60</span></div>
    </div>
  </div>

  <!-- Mobile Controls -->
  <div class="mobile-controls" id="mobileControls">
    <div class="joystick joystick-left" id="moveJoystick">
      <div class="joystick-stick" id="moveStick"></div>
    </div>
    <div class="joystick joystick-right" id="lookJoystick">
      <div class="joystick-stick" id="lookStick"></div>
    </div>
    <div class="mobile-buttons">
      <div class="mobile-btn" id="jumpBtn">قفز</div>
      <div class="mobile-btn" id="runBtn">ركض</div>
      <div class="mobile-btn" id="menuBtn">قائمة</div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { GLTFLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js";
    import { DRACOLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/DRACOLoader.js";
    import { RGBELoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/RGBELoader.js";
    import { PointerLockControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js";
    import { EffectComposer } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/EffectComposer.js";
    import { RenderPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/RenderPass.js";
    import { UnrealBloomPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/UnrealBloomPass.js";
    import { SSAOPass } from "https://unpkg.com/three@0.160.0/examples/jsm/postprocessing/SSAOPass.js";

    // ==================== Enhanced Configuration ====================
    const CONFIG = {
      MODEL_URL: 'https://raw.githubusercontent.com/kanawattown-a11y/12/f91219369eb76bb2e445f95abaa61860e3b886dd/naj.glb',
      DRACO_DECODER_PATH: 'https://www.gstatic.com/draco/v1/decoders/',
      
      // Physics - Enhanced values
      MOVE_SPEED: 8.0,
      RUN_MULTIPLIER: 2.5,
      JUMP_FORCE: 15.0,
      GRAVITY: 25.0,
      EYE_HEIGHT: 1.8,
      PLAYER_RADIUS: 0.4,
      MOUSE_SENSITIVITY: 1.5,
      
      // Performance
      SHADOW_MAP_SIZE: 4096,
      MAX_PIXEL_RATIO: 2,
      
      // Mobile detection
      IS_MOBILE: /Mobi|Android|iPhone|iPad/i.test(navigator.userAgent),
      
      // Environment settings with HDRI
      ENVIRONMENTS: {
        showroom: { 
          background: new THREE.Color(0x2d3748), 
          fog: new THREE.Color(0x2d3748),
          ambientIntensity: 0.6,
          directionalIntensity: 1.5,
          hdri: null
        },
        city: { 
          background: new THREE.Color(0x87ceeb), 
          fog: new THREE.Color(0x87ceeb),
          ambientIntensity: 0.8,
          directionalIntensity: 1.2,
          hdri: null
        },
        desert: { 
          background: new THREE.Color(0xffd700), 
          fog: new THREE.Color(0xffd700),
          ambientIntensity: 1.0,
          directionalIntensity: 2.0,
          hdri: null
        },
        night: { 
          background: new THREE.Color(0x0f172a), 
          fog: new THREE.Color(0x0f172a),
          ambientIntensity: 0.3,
          directionalIntensity: 0.8,
          hdri: null
        },
        studio: { 
          background: new THREE.Color(0xf8f8f8),
          fog: new THREE.Color(0xf8f8f8),
          ambientIntensity: 1.2,
          directionalIntensity: 1.0,
          hdri: null
        }
      }
    };

    // ==================== Global State ====================
    let scene, camera, renderer, controls, composer;
    let loadingManager, dracoLoader, gltfLoader, rgbeLoader;
    let clock = new THREE.Clock();
    let ambientLight, directionalLight, hemisphereLight;
    let gameState = {
      isPlaying: false,
      canJump: false,
      currentEnvironment: 'studio',
      playerPosition: new THREE.Vector3(0, CONFIG.EYE_HEIGHT, 5),
      settings: {
        mouseSensitivity: CONFIG.MOUSE_SENSITIVITY,
        moveSpeed: CONFIG.MOVE_SPEED,
        jumpForce: CONFIG.JUMP_FORCE,
        shadowQuality: 2
      }
    };

    // Enhanced Physics
    let velocity = new THREE.Vector3();
    let collisionBoxes = [];
    
    // Enhanced Controls
    let keys = { forward: false, back: false, left: false, right: false, run: false };
    let mobileInput = { move: { x: 0, y: 0 }, look: { x: 0, y: 0 } };
    let yaw = 0, pitch = 0;
    const maxPitch = Math.PI / 2 - 0.1;

    // Performance monitoring
    let frameCount = 0;
    let lastTime = performance.now();
    let fps = 60;

    // ==================== Initialization ====================
    function init() {
      createParticles();
      setupLoadingManager();
      setupRenderer();
      setupScene();
      setupCamera();
      setupControls();
      setupLoaders();
      setupLighting();
      setupEnvironment();
      setupPostProcessing();
      setupEventListeners();
      setupSettings();
      
      loadModel();
      animate();
    }

    function createParticles() {
      const particlesContainer = document.getElementById('particles');
      for (let i = 0; i < 50; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = Math.random() * 100 + '%';
        particle.style.animationDelay = Math.random() * 6 + 's';
        particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
        particlesContainer.appendChild(particle);
      }
    }

    function setupLoadingManager() {
      loadingManager = new THREE.LoadingManager();
      
      loadingManager.onProgress = (url, loaded, total) => {
        const progress = (loaded / total) * 100;
        document.getElementById('loadingProgress').style.width = progress + '%';
      };
      
      loadingManager.onLoad = () => {
        setTimeout(() => {
          document.getElementById('loadingScreen').classList.add('hidden');
        }, 800);
      };
    }

    function setupRenderer() {
      const container = document.getElementById('app');
      renderer = new THREE.WebGLRenderer({ 
        antialias: true,
        powerPreference: "high-performance",
        alpha: true
      });
      
      renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, CONFIG.IS_MOBILE ? 1.5 : CONFIG.MAX_PIXEL_RATIO));
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.outputColorSpace = THREE.SRGBColorSpace;
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.0;
      
      // Enable physically correct lights
      renderer.physicallyCorrectLights = true;
      
      container.appendChild(renderer.domElement);
    }

    function setupScene() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x2d3748);
      scene.fog = new THREE.Fog(0x2d3748, 50, 200);
    }

    function setupCamera() {
      camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.copy(gameState.playerPosition);
    }

    function setupControls() {
      if (!CONFIG.IS_MOBILE) {
        controls = new PointerLockControls(camera, renderer.domElement);
        scene.add(controls.getObject());
        
        controls.addEventListener('lock', () => {
          gameState.isPlaying = true;
          document.getElementById('welcomeScreen').style.display = 'none';
          document.getElementById('controlsInfo').classList.add('show');
          document.getElementById('crosshair').style.display = 'block';
          document.getElementById('envControls').style.display = 'block';
          document.getElementById('statusBar').classList.add('show');
        });
        
        controls.addEventListener('unlock', () => {
          gameState.isPlaying = false;
          document.getElementById('welcomeScreen').style.display = 'grid';
          document.getElementById('controlsInfo').classList.remove('show');
          document.getElementById('crosshair').style.display = 'none';
          document.getElementById('envControls').style.display = 'none';
          document.getElementById('statusBar').classList.remove('show');
        });
      }
    }

    function setupLoaders() {
      dracoLoader = new DRACOLoader(loadingManager);
      dracoLoader.setDecoderPath(CONFIG.DRACO_DECODER_PATH);
      
      gltfLoader = new GLTFLoader(loadingManager);
      gltfLoader.setDRACOLoader(dracoLoader);
      
      rgbeLoader = new RGBELoader(loadingManager);
    }

    function setupLighting() {
      // Enhanced ambient light
      ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      // Enhanced hemisphere light for more realistic sky lighting
      hemisphereLight = new THREE.HemisphereLight(0x87CEEB, 0x362d1d, 1.0);
      hemisphereLight.position.set(0, 50, 0);
      scene.add(hemisphereLight);
      
      // Enhanced main directional light (sun) with better shadows
      directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
      directionalLight.position.set(50, 100, 50);
      directionalLight.castShadow = true;
      directionalLight.shadow.mapSize.setScalar(CONFIG.SHADOW_MAP_SIZE);
      directionalLight.shadow.camera.near = 0.1;
      directionalLight.shadow.camera.far = 500;
      directionalLight.shadow.camera.left = -100;
      directionalLight.shadow.camera.right = 100;
      directionalLight.shadow.camera.top = 100;
      directionalLight.shadow.camera.bottom = -100;
      directionalLight.shadow.bias = -0.0001;
      directionalLight.shadow.normalBias = 0.02;
      scene.add(directionalLight);
      
      // Enhanced fill lights with better positioning
      const fillLight1 = new THREE.PointLight(0xffd700, 0.5, 80);
      fillLight1.position.set(-30, 15, -30);
      fillLight1.castShadow = true;
      fillLight1.shadow.mapSize.setScalar(1024);
      scene.add(fillLight1);
      
      const fillLight2 = new THREE.PointLight(0x87ceeb, 0.5, 80);
      fillLight2.position.set(30, 15, 30);
      fillLight2.castShadow = true;
      fillLight2.shadow.mapSize.setScalar(1024);
      scene.add(fillLight2);
      
      const fillLight3 = new THREE.PointLight(0xff6b6b, 0.3, 50);
      fillLight3.position.set(0, 20, -40);
      scene.add(fillLight3);
      
      // Add rim lighting for better model definition
      const rimLight1 = new THREE.SpotLight(0xffffff, 0.8, 100, Math.PI / 6, 0.3);
      rimLight1.position.set(-40, 25, 0);
      rimLight1.target.position.set(0, 0, 0);
      scene.add(rimLight1);
      scene.add(rimLight1.target);
      
      const rimLight2 = new THREE.SpotLight(0xffffff, 0.8, 100, Math.PI / 6, 0.3);
      rimLight2.position.set(40, 25, 0);
      rimLight2.target.position.set(0, 0, 0);
      scene.add(rimLight2);
      scene.add(rimLight2.target);
    }

    function setupEnvironment() {
      // Enhanced ground with realistic materials
      const groundGeometry = new THREE.PlaneGeometry(500, 500, 100, 100);
      
      // Create a more realistic ground material
      const groundMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x404040,
        roughness: 0.8,
        metalness: 0.1,
        transparent: true,
        opacity: 0.9
      });
      
      // Add some vertex displacement for more interesting ground
      const positions = groundGeometry.attributes.position;
      for (let i = 0; i < positions.count; i++) {
        const x = positions.getX(i);
        const z = positions.getZ(i);
        const y = Math.sin(x * 0.02) * Math.cos(z * 0.02) * 0.3 + 
                  Math.sin(x * 0.05) * Math.cos(z * 0.05) * 0.1;
        positions.setY(i, y);
      }
      groundGeometry.computeVertexNormals();
      
      const ground = new THREE.Mesh(groundGeometry, groundMaterial);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);
      
      // Add atmospheric elements
      addAtmosphericElements();
      addEnvironmentGeometry();
      
      // Set initial environment
      changeEnvironment('studio');
    }

    function addAtmosphericElements() {
      // Enhanced floating particles in 3D space
      const particleGeometry = new THREE.BufferGeometry();
      const particleCount = 2000;
      const positions = new Float32Array(particleCount * 3);
      const colors = new Float32Array(particleCount * 3);
      
      for (let i = 0; i < particleCount * 3; i += 3) {
        positions[i] = (Math.random() - 0.5) * 400;     // x
        positions[i + 1] = Math.random() * 100;          // y
        positions[i + 2] = (Math.random() - 0.5) * 400; // z
        
        // Add some color variation
        const color = new THREE.Color();
        color.setHSL(Math.random() * 0.1 + 0.5, 0.3, 0.8);
        colors[i] = color.r;
        colors[i + 1] = color.g;
        colors[i + 2] = color.b;
      }
      
      particleGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
      particleGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
      
      const particleMaterial = new THREE.PointsMaterial({
        size: 1.0,
        transparent: true,
        opacity: 0.7,
        blending: THREE.AdditiveBlending,
        vertexColors: true
      });
      
      const particles = new THREE.Points(particleGeometry, particleMaterial);
      scene.add(particles);
      
      // Enhanced particle animation
      function animateParticles() {
        const positions = particles.geometry.attributes.position.array;
        const time = clock.getElapsedTime();
        
        for (let i = 1; i < positions.length; i += 3) {
          positions[i] += 0.02; // Move up
          
          // Add some horizontal drift
          positions[i - 1] += Math.sin(time + i) * 0.001;
          positions[i + 1] += Math.cos(time + i) * 0.001;
          
          if (positions[i] > 100) {
            positions[i] = 0; // Reset to ground level
            positions[i - 1] = (Math.random() - 0.5) * 400;
            positions[i + 1] = (Math.random() - 0.5) * 400;
          }
        }
        particles.geometry.attributes.position.needsUpdate = true;
      }
      
      window.animateParticles = animateParticles;
    }

    function addEnvironmentGeometry() {
      // Add some basic environment geometry for better immersion
      const buildingGeometry = new THREE.BoxGeometry(20, 40, 20);
      const buildingMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x666666,
        roughness: 0.7,
        metalness: 0.3
      });
      
      // Create several buildings around the scene
      for (let i = 0; i < 8; i++) {
        const building = new THREE.Mesh(buildingGeometry, buildingMaterial);
        const angle = (i / 8) * Math.PI * 2;
        const radius = 150 + Math.random() * 50;
        
        building.position.set(
          Math.cos(angle) * radius,
          20,
          Math.sin(angle) * radius
        );
        building.scale.y = 0.5 + Math.random() * 1.5;
        building.castShadow = true;
        building.receiveShadow = true;
        scene.add(building);
        
        // Add collision for buildings
        addCollisionBox(building);
      }
      
      // Add some decorative elements
      const sphereGeometry = new THREE.SphereGeometry(5, 32, 32);
      const sphereMaterial = new THREE.MeshStandardMaterial({ 
        color: 0x4a90e2,
        roughness: 0.2,
        metalness: 0.8,
        emissive: 0x001122
      });
      
      for (let i = 0; i < 5; i++) {
        const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
        sphere.position.set(
          (Math.random() - 0.5) * 100,
          5,
          (Math.random() - 0.5) * 100
        );
        sphere.castShadow = true;
        sphere.receiveShadow = true;
        scene.add(sphere);
      }
    }

    function setupPostProcessing() {
      composer = new EffectComposer(renderer);
      
      const renderPass = new RenderPass(scene, camera);
      composer.addPass(renderPass);
      
      // Add bloom effect for better visual quality
      const bloomPass = new UnrealBloomPass(
        new THREE.Vector2(window.innerWidth, window.innerHeight),
        0.3, // strength
        0.4, // radius
        0.85 // threshold
      );
      composer.addPass(bloomPass);
      
      // Add SSAO for better depth perception (only on desktop for performance)
      if (!CONFIG.IS_MOBILE) {
        const ssaoPass = new SSAOPass(scene, camera, window.innerWidth, window.innerHeight);
        ssaoPass.kernelRadius = 8;
        ssaoPass.minDistance = 0.005;
        ssaoPass.maxDistance = 0.1;
        composer.addPass(ssaoPass);
      }
    }

    // ==================== Enhanced Environment System ====================
    function changeEnvironment(envName) {
      gameState.currentEnvironment = envName;
      document.getElementById('currentEnv').textContent = getEnvironmentName(envName);
      
      // Update environment controls
      document.querySelectorAll('.env-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.env === envName);
      });
      
      const env = CONFIG.ENVIRONMENTS[envName];
      if (env) {
        // Smooth transition with enhanced effects
        const currentBg = scene.background.clone();
        const targetBg = env.background.clone();
        
        let progress = 0;
        const transitionDuration = 1500; // 1.5 seconds
        const startTime = performance.now();
        
        function transition() {
          const elapsed = performance.now() - startTime;
          progress = Math.min(elapsed / transitionDuration, 1);
          
          // Smooth easing function
          const easeProgress = 1 - Math.pow(1 - progress, 3);
          
          // Interpolate background color
          scene.background.lerpColors(currentBg, targetBg, easeProgress);
          scene.fog.color.lerpColors(currentBg, targetBg, easeProgress);
          
          // Update lighting with smooth transitions
          ambientLight.intensity = 0.6 + (env.ambientIntensity - 0.6) * easeProgress;
          directionalLight.intensity = 1.5 + (env.directionalIntensity - 1.5) * easeProgress;
          hemisphereLight.intensity = 1.0 + (env.ambientIntensity - 1.0) * easeProgress * 0.5;
          
          // Update tone mapping exposure based on environment
          const targetExposure = envName === 'night' ? 0.8 : envName === 'desert' ? 1.2 : 1.0;
          renderer.toneMappingExposure = 1.0 + (targetExposure - 1.0) * easeProgress;
          
          if (progress < 1) {
            requestAnimationFrame(transition);
          }
        }
        
        transition();
      }
    }

    function getEnvironmentName(envName) {
      const names = {
        'showroom': 'معرض',
        'city': 'مدينة', 
        'desert': 'صحراء',
        'night': 'ليل',
        'studio': 'استوديو'
      };
      return names[envName] || 'معرض';
    }

    // ==================== Enhanced Model Loading ====================
    function loadModel() {
      gltfLoader.load(
        CONFIG.MODEL_URL,
        (gltf) => {
          const model = gltf.scene;
          
          // Enhanced model optimization
          model.traverse((child) => {
            if (child.isMesh) {
              child.castShadow = true;
              child.receiveShadow = true;
              
              // Enhanced material properties for PBR
              if (child.material) {
                child.material.side = THREE.FrontSide;
                
                // Convert to StandardMaterial if not already
                if (!child.material.isMeshStandardMaterial) {
                  const newMaterial = new THREE.MeshStandardMaterial();
                  newMaterial.copy(child.material);
                  newMaterial.metalness = 0.7;
                  newMaterial.roughness = 0.3;
                  child.material = newMaterial;
                }
                
                // Improve material quality
                if (child.material.map) {
                  child.material.map.anisotropy = renderer.capabilities.getMaxAnisotropy();
                  child.material.map.generateMipmaps = true;
                }
                
                // Enhanced metallic properties for car parts
                if (child.material.isMeshStandardMaterial) {
                  // Detect car body vs other parts
                  if (child.name.toLowerCase().includes('body') || 
                      child.name.toLowerCase().includes('paint')) {
                    child.material.metalness = 0.9;
                    child.material.roughness = 0.1;
                    child.material.clearcoat = 1.0;
                    child.material.clearcoatRoughness = 0.1;
                  } else if (child.name.toLowerCase().includes('chrome') || 
                             child.name.toLowerCase().includes('metal')) {
                    child.material.metalness = 1.0;
                    child.material.roughness = 0.05;
                  } else if (child.name.toLowerCase().includes('glass') || 
                             child.name.toLowerCase().includes('window')) {
                    child.material.metalness = 0.0;
                    child.material.roughness = 0.0;
                    child.material.transmission = 0.9;
                    child.material.transparent = true;
                    child.material.opacity = 0.8;
                  } else if (child.name.toLowerCase().includes('tire') || 
                             child.name.toLowerCase().includes('rubber')) {
                    child.material.metalness = 0.0;
                    child.material.roughness = 0.9;
                  } else {
                    // Default enhancement
                    child.material.metalness = Math.min(child.material.metalness + 0.3, 1.0);
                    child.material.roughness = Math.max(child.material.roughness - 0.2, 0.0);
                  }
                }
              }
              
              // Add collision
              addCollisionBox(child);
            }
          });
          
          // Position and scale model appropriately
          model.position.set(0, 0, 0);
          model.scale.setScalar(1.2); // Slightly larger for better presence
          scene.add(model);
          
          console.log('Model loaded successfully. Collision boxes:', collisionBoxes.length);
        },
        (progress) => {
          // Progress handled by loading manager
        },
        (error) => {
          console.error('Error loading model:', error);
          alert('فشل في تحميل النموذج. يرجى المحاولة مرة أخرى.');
        }
      );
    }

    function addCollisionBox(mesh) {
      mesh.updateWorldMatrix(true, true);
      const box = new THREE.Box3().setFromObject(mesh);
      if (!box.isEmpty()) {
        collisionBoxes.push(box);
      }
    }

    // ==================== Enhanced Physics System ====================
    function updatePhysics(deltaTime) {
      if (!gameState.isPlaying) return;
      
      const playerObject = CONFIG.IS_MOBILE ? camera : controls.getObject();
      
      // Apply gravity
      velocity.y -= CONFIG.GRAVITY * deltaTime;
      
      // Handle movement
      handleMovement(deltaTime, playerObject);
      
      // Apply vertical movement
      const newY = playerObject.position.y + velocity.y * deltaTime;
      
      // Ground collision with improved detection
      if (newY <= CONFIG.EYE_HEIGHT) {
        playerObject.position.y = CONFIG.EYE_HEIGHT;
        velocity.y = 0;
        gameState.canJump = true;
      } else {
        playerObject.position.y = newY;
      }
      
      // Enhanced object collision
      handleCollisions(playerObject.position);
      
      // Update position info
      updatePositionInfo(playerObject.position);
    }

    function handleMovement(deltaTime, playerObject) {
      const moveVector = new THREE.Vector3();
      
      if (CONFIG.IS_MOBILE) {
        // Enhanced mobile input with better sensitivity
        moveVector.x = mobileInput.move.x;
        moveVector.z = mobileInput.move.y;
        
        // Update camera rotation with improved sensitivity
        yaw += mobileInput.look.x * deltaTime * 4 * gameState.settings.mouseSensitivity;
        pitch += mobileInput.look.y * deltaTime * 4 * gameState.settings.mouseSensitivity;
        pitch = Math.max(-maxPitch, Math.min(maxPitch, pitch));
        
        camera.rotation.order = 'YXZ';
        camera.rotation.y = yaw;
        camera.rotation.x = pitch;
      } else {
        // Enhanced desktop input
        if (keys.forward) moveVector.z -= 1;
        if (keys.back) moveVector.z += 1;
        if (keys.left) moveVector.x -= 1;
        if (keys.right) moveVector.x += 1;
      }
      
      if (moveVector.length() > 0) {
        moveVector.normalize();
        const speed = gameState.settings.moveSpeed * (keys.run ? CONFIG.RUN_MULTIPLIER : 1.0) * deltaTime;
        
        if (CONFIG.IS_MOBILE) {
          // Enhanced mobile movement (camera-relative)
          const direction = new THREE.Vector3();
          camera.getWorldDirection(direction);
          direction.y = 0;
          direction.normalize();
          
          const right = new THREE.Vector3();
          right.crossVectors(direction, camera.up).normalize();
          
          const movement = new THREE.Vector3();
          movement.addScaledVector(direction, -moveVector.z);
          movement.addScaledVector(right, moveVector.x);
          movement.multiplyScalar(speed);
          
          playerObject.position.add(movement);
        } else {
          // Enhanced desktop movement (camera-relative)
          const direction = new THREE.Vector3();
          camera.getWorldDirection(direction);
          direction.y = 0;
          direction.normalize();
          
          const right = new THREE.Vector3();
          right.crossVectors(direction, camera.up).normalize();
          
          const movement = new THREE.Vector3();
          movement.addScaledVector(direction, -moveVector.z);
          movement.addScaledVector(right, moveVector.x);
          movement.multiplyScalar(speed);
          
          playerObject.position.add(movement);
        }
      }
    }

    function handleCollisions(position) {
      for (const box of collisionBoxes) {
        const expandedBox = box.clone().expandByScalar(CONFIG.PLAYER_RADIUS);
        if (expandedBox.containsPoint(position)) {
          const closestPoint = expandedBox.clampPoint(position.clone(), new THREE.Vector3());
          const pushVector = position.clone().sub(closestPoint);
          if (pushVector.length() > 0) {
            pushVector.normalize().multiplyScalar(CONFIG.PLAYER_RADIUS + 0.01);
            position.copy(closestPoint.add(pushVector));
          }
        }
      }
    }

    function jump() {
      if (gameState.canJump) {
        velocity.y = gameState.settings.jumpForce;
        gameState.canJump = false;
      }
    }

    function updatePositionInfo(position) {
      const x = Math.round(position.x * 10) / 10;
      const y = Math.round(position.y * 10) / 10;
      const z = Math.round(position.z * 10) / 10;
      document.getElementById('positionInfo').textContent = `${x}, ${y}, ${z}`;
    }

    // ==================== Enhanced Settings System ====================
    function setupSettings() {
      const sensitivitySlider = document.getElementById('sensitivitySlider');
      const speedSlider = document.getElementById('speedSlider');
      const jumpSlider = document.getElementById('jumpSlider');
      const shadowSlider = document.getElementById('shadowSlider');
      
      // Enhanced sensitivity control
      sensitivitySlider.addEventListener('input', (e) => {
        gameState.settings.mouseSensitivity = parseFloat(e.target.value);
        document.getElementById('sensitivityValue').textContent = e.target.value;
      });
      
      // Enhanced speed control
      speedSlider.addEventListener('input', (e) => {
        gameState.settings.moveSpeed = parseFloat(e.target.value);
        document.getElementById('speedValue').textContent = e.target.value;
      });
      
      // Enhanced jump control
      jumpSlider.addEventListener('input', (e) => {
        gameState.settings.jumpForce = parseFloat(e.target.value);
        document.getElementById('jumpValue').textContent = e.target.value;
      });
      
      // Enhanced shadow quality control
      shadowSlider.addEventListener('input', (e) => {
        const quality = parseInt(e.target.value);
        gameState.settings.shadowQuality = quality;
        
        const qualityNames = ['منخفضة', 'متوسطة', 'عالية'];
        document.getElementById('shadowValue').textContent = qualityNames[quality];
        
        // Update shadow map size based on quality
        const shadowSizes = [1024, 2048, 4096];
        const newSize = shadowSizes[quality];
        
        directionalLight.shadow.mapSize.setScalar(newSize);
        directionalLight.shadow.map?.dispose();
        directionalLight.shadow.map = null;
      });
    }

    // ==================== Enhanced Event Listeners ====================
    function setupEventListeners() {
      // Window events
      window.addEventListener('resize', onWindowResize);
      
      // Enhanced keyboard events
      document.addEventListener('keydown', onKeyDown);
      document.addEventListener('keyup', onKeyUp);
      
      // UI events
      document.getElementById('enterBtn').addEventListener('click', enterExperience);
      document.getElementById('settingsBtn').addEventListener('click', showSettings);
      document.getElementById('closeSettings').addEventListener('click', hideSettings);
      
      // Environment controls
      document.querySelectorAll('.env-btn').forEach(btn => {
        btn.addEventListener('click', () => changeEnvironment(btn.dataset.env));
      });
      
      // Enhanced mobile controls
      if (CONFIG.IS_MOBILE) {
        setupMobileControls();
      }
    }

    function onKeyDown(event) {
      if (!gameState.isPlaying) return;
      
      switch(event.code) {
        case 'KeyW':
        case 'ArrowUp':
          keys.forward = true;
          break;
        case 'KeyS':
        case 'ArrowDown':
          keys.back = true;
          break;
        case 'KeyA':
        case 'ArrowLeft':
          keys.left = true;
          break;
        case 'KeyD':
        case 'ArrowRight':
          keys.right = true;
          break;
        case 'ShiftLeft':
        case 'ShiftRight':
          keys.run = true;
          break;
        case 'Space':
          event.preventDefault();
          jump();
          break;
        case 'Escape':
          if (controls && controls.isLocked) {
            controls.unlock();
          }
          break;
        case 'KeyF':
          // Toggle fullscreen
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen();
          } else {
            document.exitFullscreen();
          }
          break;
      }
    }

    function onKeyUp(event) {
      switch(event.code) {
        case 'KeyW':
        case 'ArrowUp':
          keys.forward = false;
          break;
        case 'KeyS':
        case 'ArrowDown':
          keys.back = false;
          break;
        case 'KeyA':
        case 'ArrowLeft':
          keys.left = false;
          break;
        case 'KeyD':
        case 'ArrowRight':
          keys.right = false;
          break;
        case 'ShiftLeft':
        case 'ShiftRight':
          keys.run = false;
          break;
      }
    }

    function enterExperience() {
      if (CONFIG.IS_MOBILE) {
        // Enhanced mobile experience
        gameState.isPlaying = true;
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('mobileControls').classList.add('show');
        document.getElementById('controlsInfo').classList.add('show');
        document.getElementById('envControls').style.display = 'block';
        document.getElementById('statusBar').classList.add('show');
      } else {
        // Enhanced desktop experience
        if (controls) {
          controls.lock();
        }
      }
    }

    function showSettings() {
      document.getElementById('settingsPanel').classList.add('show');
    }

    function hideSettings() {
      document.getElementById('settingsPanel').classList.remove('show');
    }

    // ==================== Enhanced Mobile Controls ====================
    function setupMobileControls() {
      setupJoystick('moveJoystick', 'moveStick', (x, y) => {
        mobileInput.move.x = x;
        mobileInput.move.y = -y; // Invert Y for forward/back
      });
      
      setupJoystick('lookJoystick', 'lookStick', (x, y) => {
        mobileInput.look.x = -x * 3; // Enhanced sensitivity
        mobileInput.look.y = -y * 3;
      });
      
      // Enhanced mobile buttons with haptic feedback
      document.getElementById('jumpBtn').addEventListener('touchstart', (e) => {
        e.preventDefault();
        jump();
        e.target.classList.add('pressed');
        
        // Haptic feedback if available
        if (navigator.vibrate) {
          navigator.vibrate(50);
        }
      });
      
      document.getElementById('jumpBtn').addEventListener('touchend', (e) => {
        e.target.classList.remove('pressed');
      });
      
      document.getElementById('runBtn').addEventListener('touchstart', (e) => {
        e.preventDefault();
        keys.run = true;
        e.target.classList.add('pressed');
      });
      
      document.getElementById('runBtn').addEventListener('touchend', (e) => {
        keys.run = false;
        e.target.classList.remove('pressed');
      });
      
      document.getElementById('menuBtn').addEventListener('click', () => {
        gameState.isPlaying = false;
        document.getElementById('welcomeScreen').style.display = 'grid';
        document.getElementById('mobileControls').classList.remove('show');
        document.getElementById('controlsInfo').classList.remove('show');
        document.getElementById('envControls').style.display = 'none';
        document.getElementById('statusBar').classList.remove('show');
      });
    }

    function setupJoystick(containerId, stickId, onMove) {
      const container = document.getElementById(containerId);
      const stick = document.getElementById(stickId);
      let isActive = false;
      let startPos = { x: 0, y: 0 };
      const maxDistance = 60;
      
      function handleStart(e) {
        isActive = true;
        const rect = container.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        startPos.x = centerX;
        startPos.y = centerY;
        
        if (e.touches) {
          container.setPointerCapture && container.setPointerCapture(e.touches[0].identifier);
        }
        
        // Haptic feedback
        if (navigator.vibrate) {
          navigator.vibrate(30);
        }
      }
      
      function handleMove(e) {
        if (!isActive) return;
        
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        
        let deltaX = clientX - startPos.x;
        let deltaY = clientY - startPos.y;
        
        const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
        if (distance > maxDistance) {
          deltaX = (deltaX / distance) * maxDistance;
          deltaY = (deltaY / distance) * maxDistance;
        }
        
        stick.style.transform = `translate(${deltaX}px, ${deltaY}px)`;
        onMove(deltaX / maxDistance, deltaY / maxDistance);
      }
      
      function handleEnd() {
        isActive = false;
        stick.style.transform = 'translate(0px, 0px)';
        onMove(0, 0);
      }
      
      // Enhanced touch events
      container.addEventListener('touchstart', handleStart, { passive: false });
      container.addEventListener('touchmove', handleMove, { passive: false });
      container.addEventListener('touchend', handleEnd);
      container.addEventListener('touchcancel', handleEnd);
      
      // Mouse events (for testing on desktop)
      container.addEventListener('mousedown', handleStart);
      container.addEventListener('mousemove', handleMove);
      container.addEventListener('mouseup', handleEnd);
      container.addEventListener('mouseleave', handleEnd);
    }

    // ==================== Enhanced Render Loop ====================
    function animate() {
      requestAnimationFrame(animate);
      
      const deltaTime = clock.getDelta();
      
      // Update physics
      updatePhysics(deltaTime);
      
      // Animate atmospheric particles
      if (window.animateParticles) {
        window.animateParticles();
      }
      
      // Update FPS counter
      frameCount++;
      const currentTime = performance.now();
      if (currentTime - lastTime >= 1000) {
        fps = Math.round((frameCount * 1000) / (currentTime - lastTime));
        document.getElementById('fpsInfo').textContent = fps;
        frameCount = 0;
        lastTime = currentTime;
      }
      
      // Use composer for post-processing or regular renderer
      if (composer) {
        composer.render();
      } else {
        renderer.render(scene, camera);
      }
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
      
      if (composer) {
        composer.setSize(window.innerWidth, window.innerHeight);
      }
    }

    // ==================== Start Application ====================
    init();
  </script>
</body>
</html>

